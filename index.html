<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Modul Ajar Generator Profesional</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Load Libraries for Export Functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration and initialization (MANDATORY for Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        if (firebaseConfig) {
            try {
                // setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                window.firebaseApp = app;
                window.firestoreDb = db;
                window.firebaseAuth = auth;

                // Sign in logic
                const attemptAuth = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                };

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User signed in:", user.uid);
                        window.currentUserId = user.uid;
                    } else {
                        console.log("User signed out / anonymous.");
                    }
                    window.isAuthReady = true;
                });

                attemptAuth();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }
    </script>
    <style>
        /* Menggunakan font Inter dari Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --primary-blue: #3b82f6;
            --secondary-red: #ef4444;
            --text-white: #ffffff;
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Latar Belakang Gradien Hitam */
            background: linear-gradient(135deg, #1f2937 0%, #000000 100%);
            min-height: 100vh;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .custom-select, .custom-input, .custom-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-white);
            transition: all 0.3s ease;
            /* BARU: Mengatur warna aksen untuk elemen formulir ke biru */
            accent-color: var(--primary-blue); 
        }

        .custom-select:focus, .custom-input:focus, .custom-textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        
        /* Gaya Tombol Gradien */
        .btn-primary {
            background: linear-gradient(90deg, #3b82f6, #60a5fa); /* Blue gradient */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-export {
            background: linear-gradient(90deg, #ef4444, #f87171); /* Red gradient */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.4);
        }

        .output-section {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 1rem;
            padding: 2rem;
            color: var(--text-white);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Kelas untuk menahan tinggi output agar tidak bergeser */
        .fixed-min-height {
            min-height: 500px; /* Menjaga agar elemen output memiliki tinggi minimum */
        }

        /* Gaya Khusus untuk Modul Ajar */
        .module-content h1 {
             /* Sama dengan h2 output section */
            font-size: 1.75rem; 
            font-weight: 800;
            text-align: center;
            margin-top: 1rem;
            margin-bottom: 2rem;
            color: #fff;
        }

        .module-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 0.75rem;
            color: #60a5fa; /* Blue accent */
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0.5rem;
        }
        
        .module-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #f87171; /* Red accent */
        }
        
        .module-content p, .module-content ul, .module-content li {
            line-height: 1.6;
            margin-bottom: 1rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Styling untuk Daftar (List) yang rapi */
        .module-content ul {
            list-style-type: none; /* Hilangkan bullet default */
            padding-left: 0;
        }
        .module-content li {
            margin-bottom: 0.5rem;
            padding-left: 1.5rem;
            position: relative;
        }
        .module-content li::before {
            content: "\2022"; /* Custom bullet point */
            color: #60a5fa; 
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
        }
        .module-content ol li::before {
             content: ""; /* Hilangkan bullet custom untuk ordered list */
        }
        .module-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
        }
        
        /* Gaya untuk tampilan Informasi Umum (Label: Value) */
        .info-item {
            display: flex;
            margin-bottom: 0.3rem;
            line-height: 1.4;
        }
        .info-label {
            font-weight: bold;
            width: 150px; /* Lebar tetap untuk label */
            flex-shrink: 0;
            color: #a5b4fc; /* light blue */
        }
        .info-value {
            flex-grow: 1;
            padding-left: 5px;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-10 text-transparent bg-clip-text bg-gradient-to-r from-white via-blue-300 to-red-400">
            AI Modul Ajar Generator Profesional
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Panel Input (Left/Top) -->
            <div class="lg:col-span-1 p-6 bg-white/5 backdrop-blur-sm rounded-xl shadow-2xl h-fit sticky top-8" id="input-panel">
                <h2 class="text-xl font-bold mb-4 text-white">Parameter Modul Ajar</h2>
                
                <!-- 1. Tombol Input Nama Penyusun -->
                <div class="input-group">
                    <label for="penyusun" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="user" class="w-4 h-4 mr-2 text-blue-400"></i> Nama Penyusun
                    </label>
                    <input type="text" id="penyusun" class="custom-input" placeholder="Nama Guru Profesional" value="Guru Contoh A" />
                </div>
                
                <!-- 2. Tombol Pilihan Jenjang -->
                <div class="input-group">
                    <label for="jenjang" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                           <i data-lucide="graduation-cap" class="w-4 h-4 mr-2 text-blue-400"></i> Jenjang Pendidikan
                    </label>
                    <select id="jenjang" class="custom-select">
                        <option value="SD/MI">SD/MI</option>
                        <option value="SMP/MTS">SMP/MTS</option>
                        <option value="SMA/SMK/SMAN">SMA/SMK/SMAN</option>
                    </select>
                </div>

                <!-- 3. Tombol Pilihan Tingkatan -->
                <div class="input-group">
                    <label for="tingkatan" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="list-ordered" class="w-4 h-4 mr-2 text-blue-400"></i> Tingkatan/Kelas
                    </label>
                    <select id="tingkatan" class="custom-select">
                        <!-- Options generated by JS -->
                    </select>
                </div>
                
                <!-- 8. Tombol Pilihan Mata Pelajaran -->
                <div class="input-group">
                    <label for="mata-pelajaran" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="book-open" class="w-4 h-4 mr-2 text-blue-400"></i> Mata Pelajaran
                    </label>
                    <select id="mata-pelajaran" class="custom-select">
                        <!-- Options generated by JS -->
                    </select>
                </div>

                <!-- 4. Tombol Pilihan Model Pembelajaran -->
                <div class="input-group">
                    <label for="model-pembelajaran" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="brain" class="w-4 h-4 mr-2 text-blue-400"></i> Model Pembelajaran
                    </label>
                    <select id="model-pembelajaran" class="custom-select">
                        <option value="Discovery Learning">Discovery Learning</option>
                        <option value="Project Based Learning (PjBL)">Project Based Learning (PjBL)</option>
                        <option value="Problem Based Learning (PBL)">Problem Based Learning (PBL)</option>
                        <option value="Blended Learning">Blended Learning</option>
                    </select>
                </div>

                <!-- 5. Tombol Metode Pembelajaran -->
                <div class="input-group">
                    <label for="metode-pembelajaran" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="message-square-text" class="w-4 h-4 mr-2 text-blue-400"></i> Metode Pembelajaran
                    </label>
                    <select id="metode-pembelajaran" class="custom-select">
                        <option value="Diskusi dan Presentasi">Diskusi dan Presentasi</option>
                        <option value="Simulasi dan Role Play">Simulasi dan Role Play</option>
                        <option value="Eksperimen/Praktikum">Eksperimen/Praktikum</option>
                        <option value="Ceramah dan Tanya Jawab">Ceramah dan Tanya Jawab</option>
                    </select>
                </div>

                <!-- 7. Tombol Pilihan Dimensi Profil Lulusan (Checkboxes) -->
                <div class="input-group">
                    <label for="profil-lulusan-container" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="sparkles" class="w-4 h-4 mr-2 text-blue-400"></i> Dimensi Profil Lulusan
                    </label>
                    <!-- Mengganti Select Multiple dengan Checkbox Group -->
                    <div id="profil-lulusan-container" class="grid grid-cols-1 sm:grid-cols-2 gap-y-2 p-3 custom-select h-auto">
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Keimanan dan Ketakwaan" class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Keimanan dan Ketakwaan
                        </label>
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Kewargaan" class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Kewargaan
                        </label>
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Penalaran Kritis" checked class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Penalaran Kritis
                        </label>
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Kreativitas" class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Kreativitas
                        </label>
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Kolaborasi" checked class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Kolaborasi
                        </label>
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Kemandirian" class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Kemandirian
                        </label>
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Kesehatan" class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Kesehatan
                        </label>
                        <label class="flex items-center text-sm text-white/90">
                            <input type="checkbox" name="profil-lulusan" value="Komunikasi" class="mr-2 h-4 w-4 text-blue-500 bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                            Komunikasi
                        </label>
                    </div>
                </div>
                
                <!-- 6. Tombol Input Capaian Pembelajaran -->
                <div class="input-group">
                    <label for="capaian-pembelajaran" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="clipboard-list" class="w-4 h-4 mr-2 text-blue-400"></i> Capaian Pembelajaran (CP)
                    </label>
                    <textarea id="capaian-pembelajaran" rows="3" class="custom-textarea" placeholder="Contoh: Peserta didik mampu mengidentifikasi unsur-unsur dan struktur teks prosedur, serta menyusun teks prosedur sederhana."></textarea>
                </div>

                <!-- 9. Tombol Pilihan Input Materi Manual -->
                <div class="input-group">
                    <label for="materi-manual" class="block text-sm font-medium mb-1 text-white/80 flex items-center">
                        <i data-lucide="pencil-line" class="w-4 h-4 mr-2 text-blue-400"></i> Input Materi Utama (Opsional)
                    </label>
                    <textarea id="materi-manual" rows="2" class="custom-textarea" placeholder="Contoh: Teks Prosedur membuat minuman herbal."></textarea>
                </div>
                
                <!-- Tombol Generate dan Export -->
                <div class="flex flex-col space-y-4 pt-4">
                    <button id="generate-button" class="btn-primary flex items-center justify-center">
                        <i data-lucide="wand-2" class="w-5 h-5 mr-2"></i> Buat Modul Ajar AI
                    </button>
                    <div class="flex space-x-4">
                        <!-- 10. Tombol Export ke PDF -->
                        <button id="export-pdf-button" class="btn-export flex-1 flex items-center justify-center" disabled>
                            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i> Export PDF
                        </button>
                        <!-- 11. Tombol Export ke DOCS -->
                        <button id="export-docs-button" class="btn-export flex-1 flex items-center justify-center" disabled>
                            <i data-lucide="file-type-doc" class="w-5 h-5 mr-2"></i> Export DOCS
                        </button>
                    </div>
                </div>

                <!-- Status Message -->
                <div id="status-message" class="mt-4 text-center text-sm font-semibold text-white"></div>
            </div>

            <!-- Panel Output (Right/Bottom) -->
            <!-- Tambahkan fixed-min-height untuk mencegah pergeseran layout saat loading/typing -->
            <div class="lg:col-span-2 output-section min-h-[600px] fixed-min-height" id="output-container">
                <h2 class="text-2xl font-bold text-center mb-6 text-white/90">Hasil Modul Ajar</h2>
                <div id="module-output" class="module-content">
                    <div class="text-center text-white/70">
                        <i data-lucide="clipboard-check" class="w-12 h-12 mx-auto mb-3 text-blue-400"></i>
                        <p>Silakan isi parameter di sebelah kiri dan klik "Buat Modul Ajar AI" untuk menghasilkan draf modul ajar Anda.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();
        // Load jspdf UMD for compatibility
        const { jsPDF } = window.jspdf;


        // --- Data Model for Dynamic Selects ---
        const mapData = {
            'SD/MI': {
                tingkatan: [1, 2, 3, 4, 5, 6],
                mapel: [
                    'Pendidikan Agama dan Budi Pekerti',
                    'Pendidikan Pancasila',
                    'Bahasa Indonesia',
                    'Matematika',
                    'IPAS (Ilmu Pengetahuan Alam dan Sosial)', 
                    'Pendidikan Jasmani Olahraga dan Kesehatan (PJOK)',
                    'Seni dan Budaya'
                ]
            },
            'SMP/MTS': {
                tingkatan: [7, 8, 9],
                mapel: [
                    'Pendidikan Agama dan Budi Pekerti',
                    'Pendidikan Pancasila',
                    'Bahasa Indonesia',
                    'Matematika',
                    'Ilmu Pengetahuan Alam (IPA)',
                    'Ilmu Pengetahuan Sosial (IPS)',
                    'Bahasa Inggris',
                    'Pendidikan Jasmani Olahraga dan Kesehatan (PJOK)',
                    'Informatika',
                    'Seni dan Budaya',
                    'Prakarya'
                ]
            },
            'SMA/SMK/SMAN': {
                tingkatan: [10, 11, 12],
                mapel: [
                    'Pendidikan Agama dan Budi Pekerti',
                    'Pendidikan Pancasila',
                    'Bahasa Indonesia',
                    'Matematika',
                    'Bahasa Inggris',
                    'Sejarah',
                    'Pendidikan Jasmani Olahraga dan Kesehatan (PJOK)',
                    'Seni dan Budaya',
                    'Fisika',
                    'Kimia',
                    'Biologi',
                    'Informatika',
                    'Ekonomi',
                    'Sosiologi',
                    'Geografi',
                    'Antropologi',
                    'Bahasa dan Sastra Indonesia',
                    'Bahasa dan Sastra Inggris'
                ]
            }
        };

        // --- DOM Elements ---
        const jenjangEl = document.getElementById('jenjang');
        const tingkatanEl = document.getElementById('tingkatan');
        const mapelEl = document.getElementById('mata-pelajaran');
        const generateButton = document.getElementById('generate-button');
        const moduleOutput = document.getElementById('module-output');
        const statusMessage = document.getElementById('status-message');
        const exportPdfButton = document.getElementById('export-pdf-button');
        const exportDocsButton = document.getElementById('export-docs-button');
        const outputContainer = document.getElementById('output-container');
        
        // Variabel untuk mengontrol efek komposisi
        let composingInterval = null;

        // --- Utility Functions ---

        /** Updates the Tingkatan and Mata Pelajaran select boxes based on the selected Jenjang. */
        function updateSelects() {
            const selectedJenjang = jenjangEl.value;
            const data = mapData[selectedJenjang];

            // 1. Update Tingkatan
            tingkatanEl.innerHTML = data.tingkatan.map(k => `<option value="${k}">${k}</option>`).join('');

            // 2. Update Mata Pelajaran
            mapelEl.innerHTML = data.mapel.map(m => `<option value="${m}">${m}</option>`).join('');
        }
        
        /** Menampilkan pesan dinamis saat AI sedang menyusun kerangka (pre-typing). */
        function startComposingEffect() {
            stopComposingEffect(); 
            
            // Mengatur konten agar tetap di tengah dan stabil
            moduleOutput.innerHTML = `
                <div class="text-center text-white/70 flex flex-col items-center">
                    <svg class="animate-spin h-8 w-8 text-blue-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="italic text-lg text-blue-300" id="composing-text"></p>
                </div>
            `;
            const composingTextEl = document.getElementById('composing-text');
            const composingMessage = "AI sedang menyusun kerangka modul... Mohon tunggu.";
            let dotCount = 0;
            
            composingInterval = setInterval(() => {
                let dots = '.'.repeat(dotCount % 4);
                composingTextEl.textContent = composingMessage + dots;
                dotCount++;
            }, 400); 
        }

        /** Menghentikan pesan dinamis. */
        function stopComposingEffect() {
            if (composingInterval) {
                clearInterval(composingInterval);
                composingInterval = null;
            }
        }


        /** Simulates the text generation process by displaying content word-by-word. */
        function typewriterEffect(targetElement, htmlContent) {
            targetElement.innerHTML = ''; 
            const words = htmlContent.split(/(\s+|<[^>]+>)/g).filter(Boolean); 
            let i = 0;
            
            const scrollInterval = setInterval(() => {
                // Scroll container ke bawah saat konten bertambah
                outputContainer.scrollTop = outputContainer.scrollHeight; 
            }, 50);

            return new Promise(resolve => {
                function type() {
                    if (i < words.length) {
                        targetElement.innerHTML += words[i];
                        i++;
                        const isTagOrSpace = words[i-1].match(/<[^>]+>|\s+/g);
                        const delay = isTagOrSpace ? 1 : 20; 
                        requestAnimationFrame(() => setTimeout(type, delay));
                    } else {
                        clearInterval(scrollInterval);
                        resolve();
                    }
                }
                type();
            });
        }


        /** Handles the Gemini API call to generate module content. */
        async function generateModuleContent() {
            // Get input values
            const penyusun = document.getElementById('penyusun').value.trim() || 'Guru Profesional';
            const jenjang = jenjangEl.value;
            const tingkatan = tingkatanEl.value;
            const mapel = mapelEl.value;
            const model = document.getElementById('model-pembelajaran').value;
            const metode = document.getElementById('metode-pembelajaran').value;
            const cp = document.getElementById('capaian-pembelajaran').value.trim();
            const materiManual = document.getElementById('materi-manual').value.trim();
            
            // Get selected profil lulusan
            const selectedProfilElements = document.querySelectorAll('input[name="profil-lulusan"]:checked');
            const selectedProfil = Array.from(selectedProfilElements)
                                            .map(checkbox => checkbox.value)
                                            .join(', ');

            if (!cp) {
                statusMessage.textContent = '❗ Capaian Pembelajaran harus diisi.';
                statusMessage.className = 'mt-4 text-center text-sm font-semibold text-red-400';
                return;
            }

            // 1. Initial UI state & Start Composing Effect
            generateButton.disabled = true;
            exportPdfButton.disabled = true;
            exportDocsButton.disabled = true;
            
            startComposingEffect(); 
            
            statusMessage.textContent = 'Menganalisis parameter dan meminta model AI...';
            statusMessage.className = 'mt-4 text-center text-sm font-semibold text-blue-400';
            
            let successfulFetch = false;
            let lastResponseText = '';

            // PROMPT Disesuaikan agar outputnya berupa pasangan Label: Value seperti di PDF
            const userPrompt = `
                Anda adalah Asisten AI kurikulum. Buatkan kerangka Modul Ajar profesional dalam format Markdown yang KETAT dan HAMPIR SAMA PERSIS seperti struktur template Modul Ajar Kurikulum Merdeka yang formal.
                
                Struktur yang HARUS diikuti adalah:
                
                # MODUL AJAR (Tuliskan Topik Pembelajaran yang Sesuai)
                
                ## A. INFORMASI UMUM
                (Tuliskan setiap item dalam format Label: Value, tanpa menggunakan tabel markdown)
                
                * **Nama:** ${penyusun}
                * **Instansi:** [Nama Sekolah Fiktif, contoh: SMP Negeri 7 Jakarta]
                * **Fase/Kelas:** [Tentukan Fase yang Sesuai (A/B/C/D/E/F)] / Kelas ${tingkatan}
                * **Tahun Pelajaran:** 2024/2025
                * **Semester:** Ganjil
                * **Mata Pelajaran:** ${mapel}
                * **Topik Pembelajaran:** [Buatkan Topik Pembelajaran yang Relevan dengan CP] ${materiManual ? `(Materi Utama: ${materiManual})` : ''}
                * **Alokasi Waktu:** 4 x 45 Menit (2 Pertemuan)
                * **Model Pembelajaran:** ${model}
                * **Metode Pembelajaran:** ${metode}
                * **Karakteristik Peserta Didik:** Reguler/Tipikal
                * **Dimensi Profil Lulusan (DPL):** ${selectedProfil}
                * **Mitra Pembelajaran:** Teman Sebaya (Diskusi Kelompok)
                * **Lingkungan Pembelajaran:** Ruang Kelas dan Perpustakaan
                * **Pemanfaatan Digital:** Proyektor, Laptop, Internet

                
                ## B. KOMPONEN INTI
                
                ### Capaian Pembelajaran (CP)
                ${cp}
                
                ### Tujuan Pembelajaran
                [Buatkan 3-4 Tujuan Pembelajaran yang spesifik, terukur, dan sesuai dengan CP di atas.]
                
                ### Kegiatan Pembelajaran
                
                #### Kegiatan Awal (Alokasi Waktu: 15 Menit)
                * [Tuliskan prinsip pembelajaran yang digunakan, misal: Bermakna, Menggembirakan, dan Berkesadaran]
                * [Langkah-langkah Kegiatan Pembuka: Doa, Cek Kehadiran, Apersepsi, Motivasi]
                * [Sampaikan Pertanyaan Pemantik yang relevan.]
                
                #### Kegiatan Inti (Sintak Model Pembelajaran: ${model}) (Alokasi Waktu: 60 Menit)
                
                * **Memahami** (Tuliskan prinsip pembelajaran yang digunakan, misal: Mandiri, Aktif)
                    1.  [Langkah 1 sesuai sintak model: Misalnya, stimulasi masalah]
                    2.  [Langkah 2]
                
                * **Mengaplikasikan** (Tuliskan prinsip pembelajaran yang digunakan, misal: Kolaboratif, Relevan)
                    1.  [Langkah 3 sesuai sintak model: Misalnya, pengumpulan data/percobaan]
                    2.  [Langkah 4]
                
                * **Merefleksikan** (Tuliskan prinsip pembelajaran yang digunakan, misal: Kritis, Reflektif)
                    1.  [Langkah 5 sesuai sintak model: Misalnya, pembuktian/presentasi]
                    2.  [Langkah 6]
                
                #### Kegiatan Penutup (Alokasi Waktu: 15 Menit)
                * [Tuliskan prinsip pembelajaran yang digunakan, misal: Bermakna, Berkesadaran]
                * [Langkah-langkah Kegiatan Penutup: Menyimpulkan, Refleksi Siswa, Tindak Lanjut/PR]
                
                ### Asesmen
                * **Asesmen pada Awal Pembelajaran:** [Kuis singkat pengetahuan awal tentang materi Topik Pembelajaran]
                * **Asesmen pada Proses Pembelajaran:** [Observasi selama diskusi, Unjuk Kerja Kelompok]
                * **Asesmen pada Akhir Pembelajaran:** [Tes Tulis/Esai tentang Capaian Pembelajaran]
                
                ### Pengayaan dan Remedial
                * **Pengayaan:** [Aktivitas untuk siswa dengan pencapaian tinggi]
                * **Remedial:** [Aktivitas penguatan materi untuk siswa yang belum mencapai tujuan]

                
                ## C. LAMPIRAN
                
                ### Bahan Ajar
                [Jelaskan secara ringkas isi bahan ajar (contohnya: Teks, Infografis, Video Pembelajaran)]
                
                ### LKPD (Lembar Kerja Peserta Didik)
                [Jelaskan secara ringkas isi LKPD (contohnya: Lembar kerja pengamatan dan analisis kasus)]
                
                ### Media Pembelajaran
                [Sebutkan media spesifik yang digunakan (contohnya: Papan tulis, Kartu soal, Proyektor)]
                
                ### Rubrik Penilaian
                [Berikan contoh Rubrik Penilaian Sederhana untuk Asesmen Proses (Unjuk Kerja/Proyek)]
                
                ### Daftar Pustaka
                [Sebutkan minimal 3 sumber fiktif yang relevan, mengikuti format penulisan daftar pustaka]
            `;

            const systemPrompt = "Anda adalah Asisten AI kurikulum yang sangat profesional, ahli dalam menyusun Modul Ajar Kurikulum Merdeka yang lengkap, terstruktur, dan formal. Berikan output hanya dalam format Markdown yang diminta.";
            // API Key Placeholder
            const apiKey = "AIzaSyC5GTgrykz8WZvdpVyioQcih-k8n71yiPE"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const MAX_RETRIES = 3;

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        lastResponseText = text;
                        successfulFetch = true;
                        break; // Success
                    } else {
                        throw new Error("API response text is empty.");
                    }

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === MAX_RETRIES - 1) {
                        lastResponseText = "Maaf, terjadi kesalahan saat menghubungi layanan AI. Silakan coba lagi.";
                    }
                }
            }
            
            // 2. Stop Composing Effect
            stopComposingEffect(); 

            // --- Post-Generation Processing (HTML Conversion) ---
            
            let htmlContent = lastResponseText;
            
            // 1. Convert Heading # to <h1>
            htmlContent = htmlContent.replace(/^# (.*)$/gm, '<h1 class="text-3xl font-extrabold text-center mb-6 text-white/90">$&</h1>');

            // 2. Convert Header/Info List (**Label:** Value) to custom info-item classes
            const infoPattern = /\* \*\*([^\*]+)\*\*:(.*)/g;
            const lines = htmlContent.split('\n');
            let finalHtml = '';
            let inList = false;
            let listType = '';

            lines.forEach(line => {
                const trimmedLine = line.trim();
                const infoMatch = trimmedLine.match(/^\* \*\*([^\*]+)\*\*:(.*)/); // Match the custom info format
                const isOrdered = trimmedLine.match(/^[0-9]+\. /);
                const isUnordered = trimmedLine.match(/^\* /) || trimmedLine.match(/^- /);
                
                if (infoMatch) {
                    // Handle Info List (A. INFORMASI UMUM)
                    finalHtml += `<div class="info-item"><div class="info-label">${infoMatch[1].trim()}:</div><div class="info-value">${infoMatch[2].trim()}</div></div>`;
                    
                } else if (isOrdered || isUnordered) {
                    // Handle regular lists (Kegiatan Inti, dll)
                    const currentType = isOrdered ? 'ol' : 'ul';
                    
                    if (!inList) {
                        listType = currentType;
                        finalHtml += `<${listType}>`;
                        inList = true;
                    } else if (inList && listType !== currentType) {
                        finalHtml += `</${listType}><${currentType}>`;
                        listType = currentType;
                    }
                    
                    let content = trimmedLine.replace(/^[0-9]+\. /, '').replace(/^\* /, '').replace(/^- /, '');
                    // Apply bold formatting within list items
                    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    finalHtml += `<li>${content}</li>`;

                } else {
                    // Handle closing previous list
                    if (inList) {
                        finalHtml += `</${listType}>`;
                        inList = false;
                        listType = '';
                    }
                    
                    // Handle Headings and Paragraphs
                    let processedLine = line;
                    
                    // Convert remaining markdown (h2, h3, bold, paragraph breaks)
                    processedLine = processedLine
                        .replace(/^## (.*)$/gm, '<h2 class="text-xl md:text-2xl font-extrabold mt-8 pt-4 border-t border-white/10 text-transparent bg-clip-text bg-gradient-to-r from-blue-300 to-red-300">$&</h2>')
                        .replace(/^### (.*)$/gm, '<h3 class="text-lg md:text-xl font-semibold mt-4 text-red-200">$&</h3>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        
                    // Add paragraph tags for standalone text
                    if (processedLine.trim().length > 0 && !processedLine.match(/<h[123]>|<\/h[123]>|<table/i)) {
                         finalHtml += `<p>${processedLine}</p>`;
                    } else {
                        finalHtml += processedLine;
                    }
                }
            });

            // Final list cleanup
            if (inList) {
                finalHtml += `</${listType}>`;
            }
            // Remove empty paragraph tags and redundant breaks
            finalHtml = finalHtml.replace(/<p>\s*<\/p>/g, '').replace(/<br>/g, ''); 
            
            // --- Final UI Update ---

            if (successfulFetch) {
                statusMessage.textContent = 'AI sedang menuliskan modul ajar di layar Anda...';

                // 3. Start the typing effect on the generated HTML content
                await typewriterEffect(moduleOutput, finalHtml);

                // 4. Finalize UI after typing is complete
                generateButton.disabled = false;
                exportPdfButton.disabled = false;
                exportDocsButton.disabled = false;
                statusMessage.textContent = '✅ Modul Ajar berhasil dibuat!';
                statusMessage.className = 'mt-4 text-center text-sm font-semibold text-green-400';
            } else {
                // Handle failure immediately
                generateButton.disabled = false;
                exportPdfButton.disabled = true;
                exportDocsButton.disabled = true;
                moduleOutput.innerHTML = `<p class="text-red-400 font-medium">${lastResponseText}</p>`;
                statusMessage.textContent = '❌ Gagal membuat modul ajar. Silakan periksa koneksi Anda.';
                statusMessage.className = 'mt-4 text-center text-sm font-semibold text-red-400';
            }
        }

        /** Generates and downloads the content as a PDF using html2canvas and jspdf. */
        function exportToPDF() {
            if (moduleOutput.innerHTML.trim() === '' || moduleOutput.children.length === 0) {
                 statusMessage.textContent = `⚠️ Buat Modul Ajar terlebih dahulu sebelum Export PDF.`;
                 statusMessage.className = 'mt-4 text-center text-sm font-semibold text-red-400';
                 return;
            }

            statusMessage.textContent = 'Membuat PDF... Mohon tunggu.';
            statusMessage.className = 'mt-4 text-center text-sm font-semibold text-yellow-400';

            const element = document.getElementById('module-output');
            const { jsPDF } = window.jspdf;

            // Clone element to remove dark background/UI elements for clean PDF
            const clone = element.cloneNode(true);
            clone.style.backgroundColor = '#ffffff';
            clone.style.color = '#000000';
            clone.style.padding = '30px';
            clone.style.width = '100%';
            
            // Apply simple print styles to the cloned content
            clone.querySelectorAll('.module-content h1, .module-content h2, .module-content h3').forEach(el => {
                el.style.color = '#000000';
                el.style.borderBottom = '1px solid #ccc';
            });
             clone.querySelectorAll('.info-label').forEach(el => {
                el.style.color = '#000000';
            });

            document.body.appendChild(clone);

            html2canvas(clone, { scale: 2, logging: false }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const imgHeight = canvas.height * pdfWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                
                const filename = `Modul_Ajar_${document.getElementById('mapel').value}_Kelas_${document.getElementById('tingkatan').value}.pdf`;
                pdf.save(filename);
                
                document.body.removeChild(clone);

                statusMessage.textContent = `✅ Berkas ${filename} berhasil diunduh.`;
                statusMessage.className = 'mt-4 text-center text-sm font-semibold text-green-400';
            }).catch(error => {
                document.body.removeChild(clone);
                console.error("Error generating PDF:", error);
                statusMessage.textContent = '❌ Gagal membuat PDF. Periksa konsol untuk detail.';
                statusMessage.className = 'mt-4 text-center text-sm font-semibold text-red-400';
            });
        }

        /** Generates and downloads the content as a simple Word document (.doc) using Data URI. */
        function exportToDOCS() {
            if (moduleOutput.innerHTML.trim() === '' || moduleOutput.children.length === 0) {
                 statusMessage.textContent = `⚠️ Buat Modul Ajar terlebih dahulu sebelum Export DOCS.`;
                 statusMessage.className = 'mt-4 text-center text-sm font-semibold text-red-400';
                 return;
            }

            statusMessage.textContent = 'Membuat berkas DOCS...';
            statusMessage.className = 'mt-4 text-center text-sm font-semibold text-yellow-400';

            const content = document.getElementById('module-output').outerHTML;
            
            // Minimal styling for Word export
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Document</title><style>body{font-family:'Inter', sans-serif;} h1, h2, h3 { color: #000 !important; } .info-label { font-weight: bold; width: 150px; flex-shrink: 0; color: #000; } .module-content { width: 600px; margin: auto; color: #000; background: #fff; padding: 20px; } </style></head><body>";
            const footer = "</body></html>";
            const html = header + content + footer;

            const filename = `Modul_Ajar_${document.getElementById('mapel').value}_Kelas_${document.getElementById('tingkatan').value}.doc`;

            const blob = new Blob(['\ufeff', html], {
                type: 'application/msword'
            });

            // Create download link and trigger click
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            statusMessage.textContent = `✅ Berkas ${filename} berhasil diunduh.`;
            statusMessage.className = 'mt-4 text-center text-sm font-semibold text-green-400';
        }

        // --- Event Listeners and Initialization ---

        // Initial population of selects
        updateSelects();

        // Listener for Jenjang change
        jenjangEl.addEventListener('change', updateSelects);

        // Listener for Generate Button
        generateButton.addEventListener('click', generateModuleContent);

        // Listeners for Export Buttons (Updated to use functional code)
        exportPdfButton.addEventListener('click', exportToPDF);
        exportDocsButton.addEventListener('click', exportToDOCS);

        // Use a generic placeholder for the Firebase user ID on the screen if needed for context
        window.onload = () => {
             const authUserId = window.currentUserId || 'UID-Tidak-Tersedia';
             console.log("App ready. Auth State (if ready):", authUserId);
        };

    </script>
</body>
</html>
